name: Deploy Project

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          npm install html-minifier-terser jq

      - name: Build publish directory (copy only html, css and image)
        run: |
          mkdir -p ./publish
          # Copy only HTML, CSS files and the image/ directory. Exclude everything else.
          # Order of include/exclude matters: include directories, include target files, then exclude all others.
          rsync -a --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='publish' \
            --include='image/***' \
            --include='*/' \
            --include='*.html' \
            --include='*.css' \
            --exclude='*' \
            ./ ./publish/

      - name: Minify all src HTML files into single-line at publish root
        run: |
          mkdir -p ./publish
          for file in src/*.html; do
            if [ -f "$file" ]; then
              out="./publish/$(basename "$file")"
              echo "Minifying: $file -> $out"
              npx html-minifier-terser "$file" --collapse-whitespace --remove-comments --minify-css --minify-js | tr -d '\n' > "$out"
              # remove duplicated copy under publish/src if exists
              if [ -f "./publish/src/$(basename "$file")" ]; then
                rm -f "./publish/src/$(basename "$file")"
              fi
            fi
          done

      - name: Ensure image directory exists under publish
        run: |
          if [ -d image ]; then
            mkdir -p ./publish/image
            echo "image directory present in publish/image/"
          else
            echo "No image directory in repository"
          fi

      - name: Deploy to publish branch
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # skip if no changes in publish/
          if [ -z "$(git status --porcelain ./publish || true)" ]; then
            echo "No changes in publish/ to deploy. Skipping push."
            exit 0
          fi

          git add ./publish || true
          git commit -m "Deploy to publish branch" || true

          SHA=$(git subtree split --prefix publish HEAD 2>/dev/null || true)
          if [ -n "$SHA" ]; then
            git push origin ${SHA}:publish --force
          else
            echo "No publish subtree to push."
          fi