name: Deploy Project

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # リポジトリのコードをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 必要なパッケージをインストール（html-minifier-terser を使用）
      - name: Install dependencies
        run: |
          npm install html-minifier-terser jq

      # main/src 内の HTML ファイルを列挙
      - name: Get HTML files
        id: html_files
        run: |
          files=$(find src -type f -name '*.html' 2>/dev/null | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "Detected HTML files: '$files'"
          echo "files=$files" >> $GITHUB_OUTPUT

      # HTML を 1 行に圧縮して publish 直下に配置（basename を使いルート直下へ）
      - name: Minify HTML files into single line
        run: |
          mkdir -p ./publish
          for file in ${{ steps.html_files.outputs.files }}; do
            if [ -f "$file" ]; then
              out="./publish/$(basename "$file")"
              echo "Minifying: $file -> $out"
              # minify して改行を削除（1行にする）
              npx html-minifier-terser "$file" --collapse-whitespace --remove-comments --minify-css --minify-js | tr -d '\n' > "$out"
            else
              echo "Skip (not found): $file"
            fi
          done

      # main の image ディレクトリを構造そのままコピー
      - name: Copy image directory (preserve structure)
        run: |
          if [ -d image ]; then
            mkdir -p ./publish
            cp -a image ./publish/
            echo "Copied image/ -> publish/image/"
          else
            echo "No image directory to copy"
          fi

      # `publish` ディレクトリのみを抽出して publish ブランチに強制 push（rebase は行わない）
      - name: Deploy to publish branch
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # stage & commit（変更が無くてもエラーにならないようにする）
          git add ./publish || true
          git commit -m "Deploy to publish branch" || true

          # publish プレフィックスのみのコミットを作成して publish ブランチへ強制 push
          SHA=$(git subtree split --prefix publish HEAD)
          git push origin ${SHA}:publish --force